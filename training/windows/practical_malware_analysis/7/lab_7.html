<!DOCTYPE HTML>

<html>
<head>
  <meta charset="utf-8">
  <!-- Include required JS files -->
  <script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/shCore.js"></script>
  <!-- At least one brush -->
  <script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/langs/shBrushPython.js"></script>
  <script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/langs/shBrushNasm8086.js"></script>
  <script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/langs/shBrushCpp.js"></script>
  <script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/langs/shBrushBash.js"></script>
  <script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/langs/shBrushDiff.js"></script>
  <!-- Include *at least* the core style and default theme -->
  <link href="../template/syntaxhighlighter_3.0.83/css/shCore.css" rel="stylesheet" type="text/css" />
  <link href="../template/syntaxhighlighter_3.0.83/css/shThemeDefault.css" rel="stylesheet" type="text/css" />
  <!-- My styles -->
  <link href="../template/css/my_styles.css" rel="stylesheet" type="text/css" />
</head>

<body>

<h1>LAB 7-1</h1>
<h3>Analyze the malware found in the file Lab07-01.exe. Radare2 and IDA Pro will be used whenever it's suitable.</h3>

<div class="question-container">
  <div class="question">1. How does this program ensure that it continues running (achieves persistence) when the computer is restarted?</div>
  <div class="answer">
        The first thing that this program does is create a Windows Service using the Windows StartServiceCtrlDispatcher() function. The documentation for this function can be found <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms686001%28v=vs.85%29.aspx">here</a>.<br>
        The first parameter of this function is a pointer to a structure of type SERVICE_TABLE_ENTRY defined <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms686001%28v=vs.85%29.aspx">here</a>. This structure contains the name of the service to be run and the memory address of the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms685138%28v=vs.85%29.aspx">ServiceMain</a> function. This function is the one that will be called once the service starts its execution.<br>
        <br>
        <img class="centered_img" src="img/7-1.1.1.png"/>
        <br>
        In this case the pointer for this structure is built using the function stack. By placing all the structure values in the stack and the pushing the esp value to the stack.
        By inspecting the SERVICE_TABLE_ENTRY structure stored in the stack (first parameter for the StartServiceCtrlDispatcher function) we will be able to discover where is the function that will be executed once the service starts.<br>
        In this case we can see how this structure is built. The instructions that interest us are the ones in 0x00401007 and 0x00401010. We can see that the malware name will be "MalService" and the WinMain function is stored at 0x00401040.<br>
        <br>
        Now we can go to 0x00401040 to further analyze the service capabilities. I've renamed the function using the "afn CustomWinMain 0x401040" command. <br>
        <br>
        <img class="centered_img" src="img/7-1.1.2.png"/>
        <br>
        If we are in the mood, given that this is a long function we can also use the <a href="https://github.com/jpenalbae/r2-scripts/tree/master/decompiler">r2 decompiler script</a> developed by NighterMan! We only have to execute "$decompile -s $$"<br>
        <br>
        <img class="centered_img" src="img/7-1.1.3.png"/>
        <br>
        It has some bugs, as not tracing the return values of functions such as CreateWaitableTimer, but it ain't bad, isn't it? :)<br>
        <br>
        As we can see from the decompiled code or from the assembly, the sixth parameter (dwStartType) of the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682450%28v=vs.85%29.aspx">CreateProcessA<a> function is 2 (SERVICE_AUTO_START). This means that the service will be executed each time the computer boots. This is how this malware achieves persistence.
  </div>
</div>

<div class="question-container">
  <div class="question">2. Why does this program use a mutex?</div>
  <div class="answer">
    The malware uses the mutex in order to assure that only one instance of itself is running at the same time. The relevant code follows:<br>
    <br>
    <img class="centered_img" src="img/7-1.2.1.png"/>
    <br>
    As can be seen, first of all we have a call to <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms684315%28v=vs.85%29.aspx">OpenMutex<a>. This function will try to get access to a mutex called 'HGL345'. If the function succeeds (returns something different than 0) the program exits executing the ExitProcess function. On the contrary, if the function fails (returns 0) it proceeds to create a mutex with the same name using <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682411%28v=vs.85%29.aspx">CreateMute<a>. The logic is simple, if the mutex already existed (so it could be opened) means that a previous instance of the program is already in execution, if not the mutex is created so future instances of the program know that there's already one instance running.<br>
    <br>
    In the MSDN there's even a comment explaining this behavior:<br>
    <br>
    <i>If you are using a named mutex to limit your application to a single instance, a malicious user can create this mutex before you do and prevent your application from starting.</i><br>
    <br>
    One can use this methodology using mutexes because they are not part of your processes memory, but OS, so all processes can access this newly created mutex.
  </div>
</div>

<div class="question-container">
  <div class="question">3. What is a good host-based signature to use for detecting this program?</div>
  <div class="answer">
  </div>
</div>

<div class="question-container">
  <div class="question">4. What is a good network-based signature for detecting this malware?</div>
  <div class="answer">
  </div>
</div>

<div class="question-container">
  <div class="question">5. What is the purpose of this program?</div>
  <div class="answer">
  </div>
</div>

<div class="question-container">
  <div class="question">6. When will this program finish executing?</div>
  <div class="answer">
  </div>
</div>

<h1>LAB 7-2</h1>
<h3>Analyze the malware found in the file Lab07-02.exe. Radare2 and IDA Pro will be used whenever it's suitable.</h3>


<div class="question-container">
  <div class="question">1. How does this program achieve persistence?</div>
  <div class="answer">
  </div>
</div>

<div class="question-container">
  <div class="question">2. What is the purpose of this program?</div>
  <div class="answer">
  </div>
</div>

<div class="question-container">
  <div class="question">3. When will this program finish executing?</div>
  <div class="answer">
  </div>
</div>

<h1>LAB 7-3</h1>
<h3>For this lab, we obtained the malicious executable, Lab07-03.exe, and DLL, Lab07-03.dll, prior to executing. This is important to note because the mal- ware might change once it runs. Both files were found in the same directory on the victim machine. If you run the program, you should ensure that both files are in the same directory on the analysis machine. A visible IP string beginning with 127 (a loopback address) connects to the local machine. (In the real version of this malware, this address connects to a remote machine, but we’ve set it to connect to localhost to protect you.). Radare2 and IDA Pro will be used whenever it's suitable.</h3>

<i><b>WARNING</b> This lab may cause considerable damage to your computer and may be difficult to remove once installed. Do not run this file without a virtual machine with a snapshot taken prior to execution.</i><br>
<br>
This lab may be a bit more challenging than previous ones. You’ll need to use a combination of static and dynamic methods, and focus on the big picture in order to avoid getting bogged down by the details.

<div class="question-container">
  <div class="question">1. How does this program achieve persistence to ensure that it continues running when the computer is restarted?</div>
  <div class="answer">
  </div>
</div>

<div class="question-container">
  <div class="question">2. What are two good host-based signatures for this malware?</div>
  <div class="answer">
  </div>
</div>

<div class="question-container">
  <div class="question">3. What is the purpose of this program?</div>
  <div class="answer">
  </div>
</div>

<div class="question-container">
  <div class="question">4. How could you remove this malware once it is installed?</div>
  <div class="answer">
  </div>
</div>

<div class="question-container">
  <div class="question">3. template</div>
    <div class="answer">
        <pre class="brush: py;">
        ret = WININET.InternetGetConnectedState(0, 0, ecx)
        if (ret == 0):
            0x40105F(0x407030)
            return 0
        else:
            0x40105F(0x407048)
            return 1
        </pre>
        If you check the arguments for each function, you can see that they are pointing to different strings:<br>
        <br>
        <img class="centered_img" src="img/6-1.1.2.png"/>
        <br>
  </div>
</div>


<!-- Finally, to actually run the highlighter, you need to include this JS on your page -->
<script type="text/javascript">
  SyntaxHighlighter.defaults['smart-tabs'] = true;
  SyntaxHighlighter.defaults['highlight'] = [0, 0];
  SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.all()
</script>

</body>
</html>
