<!DOCTYPE HTML>

<html>
<head>
	<meta charset="utf-8">
	<!-- Include required JS files -->
	<script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/shCore.js"></script>
	<!-- At least one brush -->
	<script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/langs/shBrushPython.js"></script>
	<script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/langs/shBrushNasm8086.js"></script>
	<script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/langs/shBrushCpp.js"></script>
	<!-- Include *at least* the core style and default theme -->
	<link href="../template/syntaxhighlighter_3.0.83/css/shCore.css" rel="stylesheet" type="text/css" />
	<link href="../template/syntaxhighlighter_3.0.83/css/shThemeDefault.css" rel="stylesheet" type="text/css" />
	<!-- My styles -->
	<link href="../template/css/my_styles.css" rel="stylesheet" type="text/css" />
</head>

<body>

<h1>LAB 1-1</h1>
<h3>Analyze files Lab01-01.exe and Lab01-01.dll.</h3>

<div class="question-container">
	<div class="question">1. Upload the files to http://www.virustotal.com and view the reports. Does either file match any existing antivirus signatures?</div>
	<div class="answer">
		In the case of Lab01-01.exe, it's only detected by one antivirus. It's detected by TrendMicro-HouseCall antivirus as TROJ_GEN.F47V1003.<br>
		For Lab01-01.dll, it's detected by two antivirus. By Commtouch antivirus as W32/GenBl.290934C6!Olympus and by TrendMicro-HouseCall antivirus as TROJ_GEN.F47V1011.
	</div>
</div>

<div class="question-container">
	<div class="question">2. When were these files compiled?</div>
	<div class="answer">
		The Lab01-01.exe was compiled in the 19/19/2010 as is shown by PEView 0.9.9.0. The same goes for the DLL. <br><br>
		<img class="centered_img" src="img/compiled1.png">
	</div>
</div>

<div class="question-container">
	<div class="question">3. Are there any indications that either of these files is packed or obfuscated? If so, what are these indicators?</div>
	<div class="answer">
		Does not seem that Lab01-01.exe is packed. If it was packed, PeID would show the packer used where now shows the compiler (Microsoft Visual C++ 6.0). The same goes for the DLL. <br><br>
		<img class="centered_img" src="img/packed1.png">
	</div>
</div>

<div class="question-container">
	<div class="question">4. Do any imports hint at what this malware does? If so, which imports are they?</div>
	<div class="answer">
		In the case of Lab01-01.exe, the imported DLLs are KERNEL32.dll and MSVCRT.dll. <br>
		For the first DLL, the interesting imported functions are those that work with files such as CreateFileA(), CopyFileA(), FindNextFileA() or MapViewOfFile(). With these functions the malware can enumerate the files of the system and create or copy them. The MapViewOfFile() function is commonly used to avoid the call to WriteFile() in order to modify the contents of a file. It maps the contents of a file in memory so the program can access its contents through memory addresses. <br>
		<br>
		The MSVCRT.dll imports basic functions from the standard C library such as malloc() or exit(), therefore they don't have any kind of correlation with the malware functionalities.<br>
		<br>
		In the case of Lab01-01.dll, it imports KERNEL32.dll and WS2_32.dll. <br>
		For the first DLL, the interesting functions being imported are CreateProcessA(), CreateMutexA() and OpenMutexA(). With these functions the malware would be capable of creating processes.<br>
		<br>
		Dependency Walker shows these imports as in the following image: <br>
		<br>
		<img class="centered_img" src="img/imports1.png"><br>
		<br>
		The WS2_32.dll is a networking DLL. So the malware might have network capabilities, but in this case the functions are not imported by name but by ordinal. This means that to know which functions are exported you should look at the ordinal column of the first-right pane and search the function name with this ordinal in the second-right pane. For example, this DLL imports function ordinal 3, 4 and 9, that are closesocket(), connect() and htons(), respectively. This means that probably the malware make connections to external network hosts. But given that the ordinal function 1 (accept()) is not imported, it won't receive connections from external hosts.<br>
		<br>
		Dependency Walker shows these imports as in the following image: <br><br>
		<br>
		<img class="centered_img" src="img/imports2.png">
	</div>
</div>

<div class="question-container">
	<div class="question">5. Are there any other files or host-based indicators that you could look for on infected systems?</div>
	<div class="answer">
		There are several indicators you can search for when looking at an infected system. One of them is the hosts file (in win7 you can find it in C:\Windows\System32\drivers\etc\hosts). Malware can use this file to redirect requests to legitimate domains such as google.com to compromised web servers in order to, for example, steal email credentials. <br>
		<br>
		Another indicator you can look for are the registry keys used to set the programs that will be executed when the system is turned on. There are many registry keys used for this purpose. <a href="http://oreilly.com/windows/archive/how-to-remove-startup-programs.html">This</a> is a good resource with a long list of the registry keys used for this purpose.<br>
		<br>
		<p class="red">Using the strings utility you can find a file named kerne132.dll (with a 1 instead of an l) saved in C:\Windows\System32\. You can look for this file in order to check if a system is infected with this malware.<p>
	</div>
</div>

<div class="question-container">
	<div class="question">6. What network-based indicators could be used to find this malware on infected machines?</div>
	<div class="answer">
		Executing the program strings.exe on the Lab01-01.dll file, you can find the IP address 127.26.152.13. You might want to use the netstat application to see if an open connection to that machine is setup. If not, you might as well look at the system logs in order to identify past connections to that machine. Also, a good practice would be to filter the connections to and from that IP.<br>
		<br>
		The following image shows the strings.exe on the Lab01-01.dll.<br>
		<br>
		<img class="centered_img" src="img/strings1.png">
	</div>
</div>

<div class="question-container">
	<div class="question">7. What would you guess is the purpose of these files?</div>
	<div class="answer">
		From the basic analysis performed until now, you can only be sure about the functions imported by the malware. Therefore, one educated guess might be that this malware is used to exfiltrate information from the host, based on the imported functions (from KERNEL32.dll) used to search files from the host and read (and possibly modify) them. Then, once the resources of the system are enumerated and read, they can be send through the network (WS2_32.dll) to an external host. <br>
		One thing that is not clear for me is the use of the CreateProcessA() function. A more extensive analysis of the malware should be done.<br>
		<br>
		There is one more thing. A disturbing string that can be extracted from the Lab01-01.exe is "WARNING_THIS_WILL_DESTROY_YOUR_MACHINE"... I suppose that this is a joke, but it might be possible if all system files are mapped into memory via MapViewOfFile() and overwritten.<br>
		<br>
		<p class="red">Given that with the strings utility we can find the "exec" and "sleep" strings, it might be possible that this malware is used to execute binaries via the CreateProcess() function from the KERNEL32.dll when the "exec" order is received and to sleep via the Sleep() function from the KERNEL32.dll when the "sleep" string is received. Therefore it might work as a backdoor.</p>
	</div>
</div>


<h1>LAB 1-2</h1>
<h3>Analyze file Lab01-02.exe.</h3>

<div class="question-container">
	<div class="question">1. Upload the Lab01-02.exe file to http://www.virustotal.com/. Does it match any existing virus definition?</div>
	<div class="answer">
		Yes, it matches. 19 out of 48 antivirus detect it. It's worth noting that a lot of well-known antivirus firms don't detect it.
	</div>
	<div class="question">2. Are there any indicators that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.</div>
	<div class="answer">
		As can be seen in the following image, PEiD shows that the executable is packed with UPX. <br>
		<br>
		<img class="centered_img" src="img/packed2.png"><br>
		<br>
		To unpack it you should use the upx utility as this: upx.exe -d file<br>
		<br>
		<img class="centered_img" src="img/upx1.png"><br>
		<br>
		Once unpacked you can use PEiD again to check that the executable file is no longer packed with UPX (the executable filename should be the same as the one past to upx.exe)
	</div>
	<div class="question">3. Do any imports hint at this program's functionality? If so, which imports are they and what do they tell you?</div>
	<div class="answer">
		The following list shows the imported DLLs found with Dependency Walker and the interesting imported functions.
		<ol>
			<li>KERNEL32.dll
				<ol>
					<li>CreateThread</li>
					<li>GetModuleFileNameA</li>
					<li>CreateWaitableTimerA</li>
				</ol>
				<br>
				- With these imported functions the malware might be able to create diferent threads (CreateThead), obtain the filename of a module loaded in the current process (GetModuleFilenameA) and wait (CreateWaitableTimerA).
			</li>
			<br>
			<li>ADVAPI32.dll
				<ol>
					<li>CreateServiceA</li>
					<li>StartSeviceCtrlDispatcherA</li>
					<li>OpenSCManagerA</li>
				</ol>
				<br>
				- With these imported functions the malware might be able to create processes that start at boot time (CreateServiceA). The StartServiceCtrlDispatcherA is a mandatory function that should be call to link the main thread of the process with the previously created process. As with the previous function the OpenSCManagerA should be call when working with services.
			</li>
			<br>
			<li>MSVCRT.dll
				<ol>
					<li>Standard C library functions</li>
				</ol>
			</li>
			<br>
			<li>WININET.dll
				<ol>
					<li>InternetOpenUrlA</li>
					<li>InternetOpenA</li>
				</ol>
				<br>
				InternetOpenA initializes the high-level internet functions from WININET.dll. This function commonly sets the User-Agent used in the requests so its a good function to develop a network signature to detect the malware. The InternetOpenUrlA makes a request to an HTTP, HTTPS or FTP URL. This is a good function to build a network based signature to detect the malware if the used URL is static.
			</li>
		</ol>
	</div>
	<div class="question">4. What host - or network-based - indicators could be used to indetify this malware on infected machines?</div>
	<div class="answer">
		For the network based indicators you can check the previous answer (in the WININET.dll section). Using the strings utility we can find the supposed URL used to connect to the external host: http://www.malwareanalysisbook.com/.<br>
		<br>
		For the host based indicator you can look for a service called "MalService". Again, this string can be found with the strings utility.
	</div>
</div>


<h1>LAB 1-3</h1>
<h3>Analyze file Lab01-03.exe.</h3>

<div class="question-container">
	<div class="question">1. Upload the Lab01-03.exe file to http://www.virustotal.com/. Does it match any existing virus definition?</div>
	<div class="answer">
		The malware is detected by 36 antivirus out of 45. Most of them classify it as Trojan or Packer, so it might be packed.	
	</div>
	<div class="question">2. Are there any indicators that this file is packed or obfuscated? If so, what are these indicators? If the file is packed, unpack it if possible.</div>
	<div class="answer">
		Opening the malware with PEiD you can see that where the compiler should be shown there is the string: "FSG 1.0 -> dulek/xt". This doesn't seem a compiler, so searching in the internet for this string you obtain that FSG is a packer. A list of known packers can be found in the following site: <a href="www.openrce.org/reference_library/packer_database">OpenRCE</a>.<br>
		<br>
		<img class="centered_img" src="img/packed3.png"><br>
	</div>
	<div class="question">3. Do any imports hint at this program's functionality? If so, which imports are they and what do they tell you?</div>
	<div class="answer">
		The following list shows the imported DLLs found with Dependency Walker and the interesting imported functions.
		<ol>
			<li>KERNEL32.dll
				<ol>
					<li>GetProcAddress</li>
					<li>LoadLibraryA</li>
				</ol>
				<br>
				- This imported libraries let's the malware get the address of a function in a DLL (GetProcAddress) and to load external DLL after the malware has started.
			</li>
		</ol>
		<br>
		It's weird that a malware only imports these two functions. It may be because of the malware being packed. We will try to unpack it so as to obtain the real imported functions.<br>
		<br>
		After searching a bit, you can find several tutorials about manually unpacking this packer. One resource is <a href="http://comcrazy.net76.net/REA/Manual%20unpacking%20FSG%201.0.htm">this</a>. At this moment - decision took by the book author - we won't unpack it. Therefore this question remains unanswered.
	</div>
	<div class="question">4. What host - or network-based - indicators could be used to indetify this malware on infected machines?</div>
	<div class="answer">
		Given that the malware is packed and we are not in position to unpack it - as decided by the book author -, this question remains unanswered.
	</div>
</div>







<h1>LAB 1-4</h1>
<h3>Analyze files Lab01-04.exe.</h3>

<div class="question-container">
	<div class="question">1. Upload the Lab01-04.exe to http://www.virustotal.com and view the reports. Does either file match any existing antivirus signatures?</div>
	<div class="answer">
		This malware is detected by 39 antivirus out of 48. It's majorly marked as Trojan or Downloader. It might have network capabilities and might be used to download a more complete backdoor.
	</div>
</div>

<div class="question-container">
	<div class="question">2. Are there any indications that either of these files is packed or obfuscated? If so, what are these indicators?</div>
	<div class="answer">
		This malware is not packed as can be seen in the compiler section of PEiD:<br>
		<br>
		<img class="centered_img" src="img/packed4.png">
	</div>
</div>

<div class="question-container">
	<div class="question">3. When was this file compiled?</div>
	<div class="answer">
		Taking a look with PEview as in the first lab, you see that this file comes from the future, exactly from the 30th of August of 2019. Although it is an encouraging thing for antivirus developers (their business will remain profitable at least until 2019), we will suppose that the compiled date has been tampered.<br>
		<br>
		<img class="centered_img" src="img/compiled2.png">
	</div>
</div>

<div class="question-container">
	<div class="question">4. Do any imports hint at what this malware does? If so, which imports are they and what do they tell you?</div>
	<div class="answer">
		The following list shows the imported DLLs found with Dependency Walker and the interesting imported functions.
		<ol>
			<li>KERNEL32.dll
				<ol>
					<li>CreateFileA</li>
					<li>MoveFileA</li>
					<li>GetTempPathA</li>
					<li>GetWindowsDirectoryA</li>
					<li>WriteFile</li>
					-
					<li>FindResourceA</li>
					<li>SizeOfResource</li>
					<li>LoadResource</li>
					-
					<li>WinExec</li>
					<li>OpenProcess</li>
					<li>CreateRemoteThread</li>
					<li>GetCurrentProcess</li>
					<li>GetModuleHandleA</li>
					<li>GetProcAddress</li>
					<li>LoadLibraryA</li>

				</ol>
				<br>
				- With the first 5 listed functions, the malware has the capability of creating and moving files into, for example, the Windows directory or a temporal directory of the operating system. The next two functions might point that this malware has a hidden resource in it. Perhaps, another executable file. The last 7 imported functions can give the functionality of executing things or attaching to runing processes. With the WinExec() function, the malware might be able to execute another binary from the system (perhaps the binary is one resource of the malware itself). With the OpenProcess() or CreateRemoteThread() functions the malware might be able to inject code or data into another processes.
			</li>
			<br>
			<li>ADVAPI32.dll
				<ol>
					<li>AdjustTokenPrivileges</li>
					<li>LookupPrivilegeValueA</li>
					<li>OpenProcessToken</li>
				</ol>
				<br>
				- With these imported functions the malware might be able to enable or disable specific access privileges (AdjustTokenPrivileges). Malware that performs process injection often calls this function to gain additional permissions.
			</li>
			<br>
			<li>MSVCRT.dll
				<ol>
					<li>Standard C library functions</li>
				</ol>
			</li>
			<br>
		</ol>
	</div>
</div>

<div class="question-container">
	<div class="question">5. What host - or network-based - indicators could be used to indetify this malware on infected machines?</div>
	<div class="answer">
		Using the strings utility you can find some interesting data. The first one is the URL http://www.practicalmalwareanalysis.com/updater.exe. This is strange because we haven't found any network related imported function. This, added to the fact that with the strings utilitiy we find other function names such as URLDownloadToFileA(), means that it's probable that the malware is storing another executable file as a resource.<br>
		<br>
		As a host-based indicator, the strings utility shows a lot of paths to executable files such as \system32\wupdmgrd.exe or \winup.exe. We must search which of these files are standard Windows files and if one of them is not an standard file, check it in the infected systems.
	</div>
</div>

<div class="question-container">
	<div class="question">6. This file has one resource in the resource section. Use Resource Hacker to examine that resource, and then use it to extract the resource. What can you learn from the resource?</div>
	<div class="answer">
		The Resource Hacker utility shows that there is one resource in the malware as shown in the following image.<br>
		<br>
		<img class="centered_img" src="img/res_hack1.png">
		<br>
		With the "Action -> Save Resource as binary file..." the resource can be saved. If it is examined with Dependency Walker you can find the functions it imports:
		<br>
		<ol>
			<li>KERNEL32.dll
				<ol>
					<li>GetTempPathA</li>
					<li>GetWindowsDirectoryA</li>
					<li>WinExec</li>
				</ol>
				<br>
				- All these functions were explained in previous questions.
			</li>
			<br>
			<li>URLMON.dll
				<ol>
					<li>URLDownloadToFileA</li>
				</ol>
				<br>
				- This function is used to download a file from a web server and save it to disk.
			</li>
			<br>
			<li>MSVCRT.dll
				<ol>
					<li>Standard C library functions</li>
				</ol>
			</li>
			<br>
		</ol>
		<br>
		As stated when working with the strings utility. We have found a resource in the malware that is an executable itself that downloads a file from a web server. Once it is downloaded, it will probably be executed with the WinExec function.
	</div>
</div>



<!-- Finally, to actually run the highlighter, you need to include this JS on your page -->
<script type="text/javascript">
	SyntaxHighlighter.defaults['smart-tabs'] = true;
	SyntaxHighlighter.defaults['highlight'] = [0, 0];
	SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.all()
</script>

</body>
</html>
