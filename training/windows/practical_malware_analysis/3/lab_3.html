<!DOCTYPE HTML>

<html>
<head>
	<meta charset="utf-8">
	<!-- Include required JS files -->
	<script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/shCore.js"></script>
	<!-- At least one brush -->
	<script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/langs/shBrushPython.js"></script>
	<script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/langs/shBrushNasm8086.js"></script>
	<script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/langs/shBrushCpp.js"></script>
	<!-- Include *at least* the core style and default theme -->
	<link href="../template/syntaxhighlighter_3.0.83/css/shCore.css" rel="stylesheet" type="text/css" />
	<link href="../template/syntaxhighlighter_3.0.83/css/shThemeDefault.css" rel="stylesheet" type="text/css" />
	<!-- My styles -->
	<link href="../template/css/my_styles.css" rel="stylesheet" type="text/css" />
</head>

<body>

<h1>LAB 3-1</h1>
<h3>Analyze the malware found in the file Lab03-01.exe using basic dynamic analysis tools.</h3>

<div class="question-container">
	<div class="question">1. What are this malware's imports and strings?</div>
	<div class="answer">
        Opening the file with Dependency Walker, it seems that the binary only imports KERNEL32.dll and from it the ExitProcess() method. This could mean that the malware is packed.<br> 		
        <br>
        <img class="centered_img" src="img/3-1.1.1.png"><br>
        The following strings can be retrieved with the strings.exe tool:<br>
        <br>
        <img class="centered_img" src="img/3-1.1.2.png"><br>
        <br>
        There are strings that seem interesting because they can indicate that some other libraries might be loaded aside from KERNEL32.dll:
        <ul style="list-style-type:none">
            <li>ws2_32</li>
            <li>advapi32</li>
            <li>ntdll</li>
            <li>user32</li>
        </ul>
        We can also infer which registry keys will be modified given the following strings:
        <ul style="list-style-type:none">
            <li>SOFTWARE\Classes\http\shell\open\commandV</li>
            <li>Software\Microsoft\Active Setup\Installed Components\</li>
            <li>SOFTWARE\Microsoft\Windows\CurrentVersion\Run</li>
            <li>SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</li>
        </ul>
        And finally, we can also infer that the malware will have network capabilities:
        <ul style="list-style-type:none">
            <li>CONNECT %s:%i HTTP/1.0</li>
            <li>www.practicalmalwareanalysis.com</li>
        </ul>
        The following strings are also interesting but we cannot deduce a lot from them:
        <ul style="list-style-type:none">
            <li>StubPath</li>
            <li>VideoDriver</li>
            <li>WinVMX32-</li>
            <li>wmx32to64.exe</li>
            <li>AppData</li>
            <li>admin</li>
        </ul>
        <br>
        As we said before, the malware seemed packed. Let's check that with PEiD:<br>
        <br>
        <img class="centered_img" src="img/3-1.1.3.png"><br>
        <br>
        Indeed, it's packed with PEncrypt 3.1 Final.
	</div>
</div>

<div class="question-container">
	<div class="question">2. What are the malware's host-based indicators?</div>
	<div class="answer">
	    First of all, we can use the Regshot to know what's added to registry after the malware is executed. To do that, you first take a shot of the registry before executing the malware. Then execute it and take another shot. Then click on compare. The result will open with the notepad. In this case, we have this:<br>
        <br>
        <img class="centered_img" src="img/3-1.2.1.png"><br>
        <br>
        The most suspicious modification is the following:<br>
        <ul style="list-style-type:none">
            <li>
                HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\VideoDriver: 43 3A 5C 57 49 4E 44 4F 57 53 5C 73 79 73 74 65 6D 33 32 5C 76 6D 78 33 32 74 6F 36 34 2E 65 78 65
            </li>
        </ul>
        If we take the bytes shown as the key value, we have: C:\WINDOWS\system32\vmx32to64.exe<br>
        <br>
        This means that we have two host-based indicators, the first one is the creation of the new registry key. The second one is the creation of the vmx32to64.exe file in the system32 directory.<br>
        <br>
        Another more reliable way to detect this is by using procmon and tracking all the events that are produced by the malware.<br>
        Before executing the malware, run procmon and then execute the malware.<br>
        Procmon will track all functions called by the malware, then you can apply filters to the captured data as follows:<br>
        <br>
        <img class="centered_img" src="img/3-1.2.2.png"><br>
        <br>
        Here we have set to only trace the events of the process called Lab03-01.exe. <br>
        We can also set filters to trace only certain actions, for example, the WriteFile functions. This would be done setting Operation --> is --> WriteFile. When you apply the changes, you will get the following results.<br>
        <br>
        <img class="centered_img" src="img/3-1.2.3.png"><br>
        <br>
        As can be seen, the malware writes the vmx32to64.exe file into the C:\WINDOWS\system32 directory. This is something we didn't catch before.<br>
        <br>
        You can also trace, for example, all the modifications done to the registry, setting Operation to RegSetValue.<br>
        <br>
            <img class="centered_img" src="img/3-1.2.4.png"><br>
        <br>
        <br>
        Although using Procmon you could also know which DLL are loaded (tracing the LoadImage event), it's important to note that using Process Explorer, you can find out that a lot of DLLs are loaded. Among them, there are DLLs focused in giving network capabilities, so it's important to analyze the malware's communication.<br>
        <br>
            <img class="centered_img" src="img/3-1.2.5.png"><br>
        <br>
        As you can see, we can detect that a lot of DLL have been loaded, among them, network focused DLLs.<br>
        <br>
        <br>
        To sum up, the host-based indicators to detect this malware would be the creation of the mentioned registry key and file.
	</div>
</div>

<div class="question-container">
	<div class="question">3. Are there any useful network-based signatures for this malware? If so, what are they?</div>
	<div class="answer">
	    Previously we detected that the malware loads network related DLLs. For this reason we must monitor our network in order to catch if data is being sent. To this end we will use ApateDNS, Wireshark and Netcat.<br>
        First of all, we set ApateDNS to resolve the DNS requests of the malware and deceive it by telling that the C2 server IP address is the one we choose.<br>
        <br>
            <img class="centered_img" src="img/3-1.3.1.png"><br>
        <br>
        ApateDNS will give back 1.1.1.1 IP for any DNS request done in this machine. This IP is the IP of the machine itself. So in this machine we also set up Netcat to listen to communications to port 80 and 443. We redirect all info sent to this ports to a file, so we can analyze it later.<br>
        <br>
            <img class="centered_img" src="img/3-1.3.2.png"><br>
        <br>
        Once the malware is executed we can see that the netcat logs the information sent to the 443 port. We can read it opening the file:<br>
        <br>
            <img class="centered_img" src="img/3-1.3.3.png"><br>
        <br>
        We can also check this fact with procmon, looking at network activity:<br>
        <br>
            <img class="centered_img" src="img/3-1.3.4.png"><br>
        <br>
        We would have to investigate further to understand what's sent over the network. At least we correctly detected the C&C domain server. <br>
        Finally, although Wireshark was used, it didn't sniff anything a aside from the ARP requests.
	</div>
</div>



<h1>LAB 3-2</h1>
<h3>Analyze the malware found in the file Lab03-02.dll using basic dynamic analysis tools.</h3>

<div class="question-container">
	<div class="question">1. How can you get this malware to install itself?</div>
	<div class="answer">
	    We would have to create a binary that loaded the DLL with, for example, the LoadLibrary() method. Then we would have to call to any of the exported methods of the DLL. We can identify those methods with the PEview tool:<br>
        <br>
            <img class="centered_img" src="img/3-2.1.1.png"><br>
        <br>
        The most logic action would be to call the Install() or InstallA() exported method. Then, probably, the ServiceMain() method.<br>
        <br>
        <p class="red">A built-in functionality as the explained above is implemented by de rundll32.exe binary. You can use it in this way:<br>
        <ul style="list-style-type:none">
            <li>
                <p class="red">rundll32.exe Lab03-02.dll,installA</p>
            </li>
        </ul>
        </p>
	</div>
</div>

<div class="question-container">
	<div class="question">2. How would you get this malware to run after installation?</div>
	<div class="answer">
        It seems that the malware installs itself as a service, or at least, it creates and handles services. This can be infered using Dependency Walker and looking at which methods are imported from the loaded modules. As can be seen in the following image, the ADVAPI32.DLL is loaded and methods as CloseServiceHandler, CreateServiceA, OpenServiceA or OpenSCManagerA are imported.<br>
        <br>
            <img class="centered_img" src="img/3-2.1.2.png"><br>
        <br>
        In order to know which service is installed we'll have to further analyze the malware. Using Procmon to identify what has happened once executed the malware via rundll32.exe is somewhat hard, so another approach is to use Regshot.exe identify what entries have been modified in the registry. Let's take a look at the result:<br>
        <br>
            <img class="centered_img" src="img/3-2.1.3.png"><br>
        <br>
        As can be seen, a new service is registered in the "Services" registry key by creating the "IPRIP" entry. With this information we know the name of the service, looking at the modified keys we can see some attributes of this service. <br>
        <br>
        <ul style="list-style-type:none">
            <li>
                HKLM\SYSTEM\ControlSet001\Services\IPRIP\Parameters\ServiceDll: "C:\Documents and Settings\Administrator\Desktop\Chapter_3L\Lab03-02.dll"
                HKLM\SYSTEM\ControlSet001\Services\IPRIP\Type: 0x00000020
                HKLM\SYSTEM\ControlSet001\Services\IPRIP\Start: 0x00000002
                HKLM\SYSTEM\ControlSet001\Services\IPRIP\ErrorControl: 0x00000001
                HKLM\SYSTEM\ControlSet001\Services\IPRIP\ImagePath: "%SystemRoot%\System32\svchost.exe -k netsvcs"
                HKLM\SYSTEM\ControlSet001\Services\IPRIP\DisplayName: "Intranet Network Awareness (INA+)"
                HKLM\SYSTEM\ControlSet001\Services\IPRIP\ObjectName: "LocalSystem"
                HKLM\SYSTEM\ControlSet001\Services\IPRIP\Description: "Depends INA+, Collects and stores network configuration and location information, and notifies applications when this information changes."
                HKLM\SYSTEM\ControlSet001\Services\IPRIP\DependOnService: 'RpcSs'
            </li>
        </ul> 
        <br>
        Here you have some information about the setted values for the service: https://support.microsoft.com/kb/103000 <br>
        <br>
        To get this information using procmon we would have to filter events by, for example, "process name" equal to "rundll32.exe". The problem is that we'll have a lot of events, not necessarily only related to our malware. In any case, we can see the same information as with Regshot.exe: <br>
        <br>
            <img class="centered_img" src="img/3-2.1.4.png"><br>
        <br>
        If we open "Administrative Tools" and execute the "Services" tool, we can see how the service has been installed and see that the "Startup Type" is set to "Automatic", so the service will be started in each boot of the system.<br>
        <br>
            <img class="centered_img" src="img/3-2.1.5.png"><br>
        <br>
        There's another important point. Using the strings.exe tool we can see that there's a registry key listed that has not been modified. We might want to look in procmon if something happened to that key. To this end, applying the filter "Path" --> "includes" --> "CurrentVersion\Svchost" will do the trick:<br>
        <br>
            <img class="centered_img" src="img/3-2.1.7.png"><br>
            <img class="centered_img" src="img/3-2.1.6.png"><br>
        <br>
        In this link we can find more information about malware using services: http://www.bleepingcomputer.com/tutorials/how-malware-hides-as-a-service/<br>
        Now that we know the service name, we can start it using the following command:<br>
        <ul> 
            <li>
                net start IPRIP
            </li>
        </ul> 

        
    </div>
</div>

<div class="question-container">
	<div class="question">3. How can you find the process under which this malware is runnning?</div>
	<div class="answer">
	    First of all we have to start the service and trace what happens then. <br>
        We know that the service is started through the svchost.exe process. We have to find which of them (can be more than one svchost.exe) is the one that handles the malware. <br>
        As we previously saw, the service will load the Lab03-02.dll binary image, so we can search using Process Explorer which process has opened this DLL. <br>
        Going to "Find" --> "Find Handle or DLL" and search "Lab03-02.dll":<br>
        <br>
            <img class="centered_img" src="img/3-2.1.8.png"><br>
        <br>
        
	</div>
</div>

<div class="question-container">
	<div class="question">4. Which filters could you set in order to use procmon to glean information?</div>
	<div class="answer">
        Now that we know which process has started the malware, we can use the following filter in procmon to glean information: <br>
        "PID" --> "is" --> "1224". <br>
        We have found the PID of the malware using Process Explorer (previous question).<br>
	</div>
</div>

<div class="question-container">
	<div class="question">5. What are the malware host-based indicators?</div>
	<div class="answer">
        In question 2 we have already listed some indicators related to the registry and the binary image.<br> 	
        After looking through procmon events using the PID of the process, no new indicators have been found.
	</div>
</div>

<div class="question-container">
	<div class="question">6. Are there useful network-based signatures for this malware?</div>
	<div class="answer">
	    Playing with procmon and only tracing network events, we can see that the malware sends data through the network:<br>
        <br>
            <img class="centered_img" src="img/3-2.1.9.png"><br>
        <br>
        Using ApateDNS we can find out that a DNS request is done to www.practicalmalwareanalisys.com: <br>
        <br>
            <img class="centered_img" src="img/3-2.1.10.png"><br>
        <br>
        We also put netcat to listen port 80, given that we have seen using procmon that a connection to http port is done:<br>
        <ul> 
            <li>
                netcat.exe -l -p 80 > com_80.txt
            </li>
        </ul> 
        This will generate a file with the following contents:<br>
        <ul style="list-style-type:none">
            <li>
            GET /serve.html HTTP/1.1<br>
            Accept: */*<br>
            User-Agent: newlog-e1ee0754 Windows XP 6.11<br>
            Host: practicalmalwareanalysis.com<br>
            </li>
        </ul> 
        So we can use the DNS request and this HTTP request to create network-based indicators.
	</div>
</div>





<h1>LAB 3-3</h1>
<h3>Execute the malware found in the file Lab03-03.exe while monitoring it using basic dynamic analysis tools in a safe environment.</h3>

<div class="question-container">
	<div class="question">1. What do you notice when monitoring this malware with Process Explorer?</div>
	<div class="answer">
	    The process doesn't show itself in Process Explorer or Task Manager.<br>
        Nevertheless you can trace its actions using Procmon and setting a filter such as "Image Path" --> "is" --> "path_to_Lab03-03.exe".<br>
        This means that the Process Explorer methods have been probably hooked to not show the malware process.<br>
        <br>
        This can be confirmed because in the directory in which the malware is placed a file has been created that logs all the keys pressed in Process Explorer context.<br>
        <br>
        On the other hand, visualizing the events with Procmon using that filter, we find out that there are very suspicious calls to CreateFile method with the svchosts.exe path. And also we have a final ProcessCreate call with svchosts.exe as process. This can mean that a new svchosts.exe file has been created and executed. <br>
        <br>
        <br>
            <img class="centered_img" src="img/3-3.1.1.png"><br>
        <br>
        So the next step would be to check if the hash of the svchosts.exe file is the same as in the clean VM.<br>
        The whirpool hash is used because it's less probable that the algorithm or binary calls have been hooked or modified.<br>
        <br>
            <img class="centered_img" src="img/3-3.1.2.png"><br>
        <br>
        We revert to a clen snapshot and compute the hash of the original svchosts.exe file:<br>
        <br>
            <img class="centered_img" src="img/3-3.1.3.png"><br>
        <br>
        It seems that the result is the same, so the binary seems to not be modified.<br>
        <br>
        Nevertheless, if we check the last svchosts.exe process created in Process Explorer (right button --> Properties) with any other svchosts.exe process already opened we can find some differences: <br>
        <br>
            <img class="centered_img" src="img/3-3.1.4.png"><br>
            <img class="centered_img" src="img/3-3.1.5.png"><br>
        <br>
        And looking at the opened handlers by this svchosts.exe process we find a reference to the malware directory:<br>
        <br>
            <img class="centered_img" src="img/3-3.1.6.png"><br>
        <br>
        So we are sure that this process has something to do with the malware. The next step would be to get its PID and look at its events with Procmon.<br>
        <br>
        <p class="red">
            It's important to note that the last svchosts.exe process is an orphaned process, meaning that it has no parent. This is a very weird thing in svchosts.exe because it usually has services.exe as a parent. 
        </p>
        
	</div>
</div>

<div class="question-container">
	<div class="question">2. Can you identify any live memory modifications?</div>
	<div class="answer">
	    We have identified some of them in the previous question, listing the strings in memory of two different svchosts.exe processes. One being the malware itself.	
	</div>
</div>

<div class="question-container">
	<div class="question">3. What are the malware's host-based indicators?</div>
	<div class="answer">
        Applying the CreateFile and RegSetValue filters in Procmon to the PID of the svchosts.exe process we can find out that there's only one file created by the malware:<br> 
        <br>
            <img class="centered_img" src="img/3-3.1.7.png"><br>
        <br>
        Opening it with a text editor we can find out that all the user's events are logged to the file.<br>
        <br>
        Analyzing the loaded DLLs and the strings of the process it seems that there's no capability to send this file to a remote server. Nevertheless, this cannot be confirmed without proceding with a more detailed analysis. The malware could load a dynamic library (the LoadLibrary method is imported) building the name of the library dynamically by concatenating letters.
	</div>
</div>

<div class="question-container">
	<div class="question">4. What is the purpose of this program?</div>
	<div class="answer">
		The purpose of the malware is to log all the events generated by the user, such as key presses, process tracing, etc.
	</div>
</div>



<h1>LAB 3-4</h1>
<h3>Analyze the malware found in the file Lab03-04.exe using basic dynamic analysis tools. (This program is further analyzed in Chapter 9 labs)</h3>

<div class="question-container">
	<div class="question">1. What happens when you run this file?</div>
	<div class="answer">
        The binary file is erased from its original location. There's no new process in Process Explorer.<br>
        Even though we can track its events using Procmon and setting a filter such as "Image Path" --> "is" --> "path_to_Lab03-04.exe", although it no longer exists.
	</div>
</div>

<div class="question-container">
	<div class="question">2. What is causing the roadblock in dynamic analysis?</div>
	<div class="answer">
	    As stated previously, this program can be traced using Procmon. We can see some host-based indicators such as written registry values related with Internet Explorer settings.	
	</div>
</div>

<div class="question-container">
	<div class="question">3. Are there other ways to run this program?</div>
	<div class="answer">
        Directly related with the previous question, it seems that the malware imports the ExecuteShell method from SHEL32.DLL module. This might mean that the malware needs to be executed from the shell or that it executes another script. We would need a more detailed analisys to identify this.<br>
        We can see with the strings.exe tool that there are strings such as "cmd.exe" which would reaffirm what has been stated above. There are also strings such as "-in" or "-re" that might be arguments for the shell script.
	</div>
</div>





<!-- Finally, to actually run the highlighter, you need to include this JS on your page -->
<script type="text/javascript">
	SyntaxHighlighter.defaults['smart-tabs'] = true;
	SyntaxHighlighter.defaults['highlight'] = [0, 0];
	SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.all()
</script>

</body>
</html>
