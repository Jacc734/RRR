<!DOCTYPE HTML>

<html>
<head>
	<meta charset="utf-8">
	<!-- Include required JS files -->
	<script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/shCore.js"></script>
	<!-- At least one brush -->
	<script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/langs/shBrushPython.js"></script>
	<script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/langs/shBrushNasm8086.js"></script>
	<script type="text/javascript" src="../template/syntaxhighlighter_3.0.83/js/langs/shBrushCpp.js"></script>
	<!-- Include *at least* the core style and default theme -->
	<link href="../template/syntaxhighlighter_3.0.83/css/shCore.css" rel="stylesheet" type="text/css" />
	<link href="../template/syntaxhighlighter_3.0.83/css/shThemeDefault.css" rel="stylesheet" type="text/css" />
	<!-- My styles -->
	<link href="../template/css/my_styles.css" rel="stylesheet" type="text/css" />
</head>

<body>

<h1>LAB 5-1</h1>
<h3>Analyze the malware found in the file Lab05-01.dll using only IDA Pro. As a bonus, we'll also use Radare2!</h3>

<div class="question-container">
	<div class="question">1. What is the address of DLLMain?</div>
	<div class="answer">
        With IDA Pro, once you open the DLL you are pointed directly to DLLMain. To know the address you can go to "Options" --> "General" and check "Line Prefixes". This will show that DllMain function is located at 0x1000D02E.<br>
        <br>
        <img class="centered_img" src="img/5-1.1.1.png"/>
        <br>
        There are other ways to find it using IDA Pro. You can also search the symbol using the option "Search" --> "text" and writing DllMain. It might not land in the function definition but you can double-click the symbol to go the the definition. <br>
        Another option is going to the Function Window at "Windows" --> "Functions window" (or Alt+1) and scroll until you find DllMain.<br>
        <br>
        <br>
        With <b>r2</b> it seems that the symbol is not found. You can list all functions using the command "afl" once the binary is opened with "$r2 Lab05-01.dll". To grep you can use "afl~Main", but as can be seen, the DllMain function is not listed:<br>
        <br>
        <img class="centered_img" src="img/5-1.1.2.png"/>
        <br>
        We can see that in the DllMain address (from r2 prompt "$r2 Lab03-01.dll" seek offset as "s 0x1000D02E" and enter in Visual mode "V"), r2 tells us that the symbol is called sub.MSVCRT.dll_strncpy_2e, so it doesn't correctly detect the symbol:<br>
        <br>
        <img class="centered_img" src="img/5-1.1.3.png"/>
        <br>
        Nevertheless, the disassembled code is the same as in IDA Pro.
	</div>
</div>

<div class="question-container">
    <div class="question">2. Use the Imports window to browse to gethostbyname. Where is the import located?</div>
	<div class="answer">
            
	</div>
</div>

<div class="question-container">
	<div class="question">3. How many functions call gethostbyname?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">4. Focusing on the call to gethostbyname located at 0x10001757, can you figure out which DNS request will be made?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">5. How many local variables has Ida Pro recognized for the subroutine at 0x10001656?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">6. How many parameters has IDA Pro recognized for the subroutine at 0x10001656?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">7. Use the Strings window to locate the string \cmd.exe /c in the disassembly. Where is it located?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">8. What is happening in the area of code that references \cmd.exe /c?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">9. In the same area, at 0x100101C8, it looks like dword_1008E5C4 is a global variable that helps decide which path to take. How does the malware set dword_1008E5C4? (Hint: Use dword_1008E5C4 cross-references)</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">10. A few hundred lines into the subroutine at 0x1000FF58, a series of comparisons use memcmp to compare strings. What happens if the string comparison to robotwork is successful (when memcpy returns 0)?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">11. What does the export PSLIST do?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">12. Use the graph mode to graph the cross-reference from sub_10004E79. Which API functions could be called by entering this function? Based on the API functions alone, what could you rename this function?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">13. How many windows API functions does DLLMain call directly? How many at a depth of 2?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">14. At 0x10001358, there is a call to Sleep (an API function that takes one parameter containing the number if milliseconds to sleep). Looking backward through the code, how long will the program sleep if this code executes?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">15. At 0x10001701 is a call to socket. What are the three parameters?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">16. Using the MSDN page for socket and the named symbolic constants functionality in IDA Pro, can you make the parameters more meaningful? What are the parameters after you apply the changes?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">17. Search for usage of the in instruction (opcode 0xED). This instruction is used with a magic string VMXh to perform VMware detection. Is that in use in this malware? Using the cross-reference to the function that executes the in instruction, is there further evidence of VMware detection?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">18. Jump your cursor to 0x1001D988, What do you find?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">19. If you have the IDA Python plugin installed (included with the comercial version of IDA Pro), run Lab05-01.py, an IDA Pro python script provided with the malware for this book. (Make sure the cursor is at 0x1001D988). What happens after you run the script?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">20. With the cursor in the same location, how do you turn this data into a single string?</div>
	<div class="answer">
        
	</div>
</div>

<div class="question-container">
	<div class="question">21. Open the script with a text editor. How does it work?</div>
	<div class="answer">
        
	</div>
</div>




<!-- Finally, to actually run the highlighter, you need to include this JS on your page -->
<script type="text/javascript">
	SyntaxHighlighter.defaults['smart-tabs'] = true;
	SyntaxHighlighter.defaults['highlight'] = [0, 0];
	SyntaxHighlighter.defaults['toolbar'] = false;
    SyntaxHighlighter.all()
</script>

</body>
</html>
